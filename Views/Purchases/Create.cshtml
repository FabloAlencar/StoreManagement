@model StoresManagement.ViewModels.PurchaseFormViewModel

@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>Create</h1>

<h4>Purchase</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form id="newPurchase" asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div>
                <div class="form-group">
                    @Html.LabelFor(m => m.Branch.Name)
                    @Html.DropDownListFor(m => m.BranchId, new SelectList(Model.Branches, "Id", "Name"), "Select Branch", new { @class = "form-control" })
                </div>
                <div class="form-group">
                    <label asp-for="Customer.FullName" class="control-label"></label>
                    <input id="CustomerFullName" asp-for="Customer.FullName" class="form-control" />
                    <input id="CustomerId" type="hidden" asp-for="CustomerId" />
                </div>
            </div>

            <div>
                <div>
                    <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#exampleModal">
                        <span class="oi oi-plus pr-2"></span>Add Sale
                    </button>
                </div>
                <div>
                    <h2 class="text-right pt-3">Purchase Total</h2>
                    <h1 class="text-right pb-3" id="purchaseTotal"></h1>
                </div>
            </div>

            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

<!-- New Purchase Item -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">NEW PURCHASE ITEM</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    @Html.LabelFor(m => m.Product.Name)
                    @Html.DropDownListFor(m => m.Product, new SelectList(Model.Products, "Id", "Name"), "Select Product", new { @class = "form-control" })
                </div>
                <div class="form-group">
                    <label for="itemPrice">Item Price:</label>
                    <input type="number" class="form-control" id="itemPrice" placeholder="Enter Price">
                </div>
                <div class="form-group">
                    <label for="itemQuantity">Item Quantity:</label>
                    <input type="number" class="form-control" id="itemQuantity" placeholder="Enter Quantity">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="addSale()">Add Item</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>

        // Values from the form
        let branchID = document.getElementById('BranchId');
        let customerID = document.getElementById('CustomerId');
        let purchaseTotalLabel = document.getElementById('purchaseTotal');
        let newProductId = document.getElementById('Product');
        let newQuantity = document.getElementById('itemQuantity');
        let newPrice = document.getElementById('itemPrice');

        let purchaseItems = [];
        let purchaseTotal = 0;

        function addSale() {

            let quantityItem = parseInt(newQuantity.value);
            let currentPriceItem = parseInt(newPrice.value);
            let purchaseTotalItem = quantityItem * currentPriceItem;

            purchaseTotal += purchaseTotalItem;
            purchaseTotalLabel.innerHTML = purchaseTotal;

            purchaseItems.push({
                ProductId: parseInt(newProductId.value),
                ProductQuantity: quantityItem,
                ProductCurrentPrice: currentPriceItem,
                Total: purchaseTotalItem,
                DiscountTotal: 0
            });
        };

        var validator = $("#newPurchase").validate({
            submitHandler: function () {

                let Purchase = JSON.stringify(
                    {
                        BranchId: parseInt(branchID.value)
                        , CustomerId: parseInt(customerID.value)
                        , Total: 0
                        , Discount: 0
                        , PurchaseItems: purchaseItems
                    });

                $.ajax({
                    url: '/Purchases/Create',
                    data: Purchase,
                    type: 'POST',
                    contentType: 'application/json',
                    dataType: 'json'
                    , success: function () { validator.resetForm(); window.location = '/Purchases'; }
                    , error: function (xhr, status, error) { alert('Error:' + error); console.log(xhr); console.log(status); console.log(error); }
                });

                return false;
            }
        });
    </script>

}